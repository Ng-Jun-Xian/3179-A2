<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The World of Coffee: A Visual Narrative</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <style>
        /* Root Variables */
        :root {
            --font-serif: 'Playfair Display', serif;
            --font-body: 'Lora', serif;
            --color-background: #FDFDFB;
            --color-text: #1A1A1A;
            --color-accent: #8B4513;
            --color-accent-light: #D4915D;
            --color-subtle: #5A5A5A;
            --color-highlight: #F5EFE7;
            --spacing-unit: 1.5rem;
            --max-width: 1400px;
            --line-height: 1.75;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: var(--line-height);
            font-size: 1.0625rem; /* 17px - BASE BODY TEXT */
        }

        /* Layout Container - Fixed Width */
        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 2);
        }

        /* Typography */
        header {
            text-align: center;
            margin-bottom: calc(var(--spacing-unit) * 3);
            padding-bottom: calc(var(--spacing-unit) * 3);
            border-bottom: 2px solid var(--color-accent);
        }

        h1 {
            font-family: var(--font-serif);
            font-size: 3.5rem; /* 56px - MAIN TITLE */
            font-weight: 900;
            letter-spacing: -0.02em;
            margin-bottom: calc(var(--spacing-unit) * 0.75);
            color: var(--color-accent);
            line-height: 1.1;
        }

        .subtitle {
            font-size: 1.25rem; /* 20px - SUBTITLE */
            font-style: italic;
            color: var(--color-subtle);
            max-width: 42rem;
            margin: 0 auto;
            font-weight: 400;
        }

        h2 {
            font-family: var(--font-serif);
            font-size: 2.5rem; /* 40px - SECTION TITLES */
            font-weight: 700;
            text-align: center;
            margin-bottom: calc(var(--spacing-unit) * 0.75);
            color: var(--color-text);
            letter-spacing: -0.01em;
            line-height: 1.2;
        }

        .section-intro {
            text-align: center;
            font-size: 1.0625rem; /* 17px - SAME AS BODY (CONSISTENT) */
            color: var(--color-subtle);
            max-width: 50rem;
            margin: 0 auto calc(var(--spacing-unit) * 2.5) auto;
            line-height: 1.6;
            font-style: italic;
        }

        /* Section Dividers */
        hr.divider {
            border: none;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--color-accent-light), transparent);
            margin: calc(var(--spacing-unit) * 4) auto;
            width: 60%;
        }

        /* Grid Layouts - CHART-DOMINANT Layout */
        .section-grid {
            display: grid;
            grid-template-columns: 2.05fr 1fr;
            gap: calc(var(--spacing-unit) * 1.5);
            align-items: start;
            margin-bottom: calc(var(--spacing-unit) * 4);
        }

        .section-grid.reverse {
            grid-template-columns: 1fr 2.05fr;
            gap: calc(var(--spacing-unit) * 1.5);
        }

        .section-grid.equal {
            grid-template-columns: 1fr 1fr;
            gap: calc(var(--spacing-unit) * 1.5);
        }

        /* Responsive Full-Width Charts */
        .full-width-chart {
            margin-bottom: calc(var(--spacing-unit) * 2);
            width: 100%;
            overflow: visible;
            display: flex;
            justify-content: center;
        }

        .full-width-chart .chart-container {
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0;
        }

        .full-width-chart .chart-container > div {
            width: 100% !important;
            max-width: 100% !important;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .full-width-chart .chart-container > div > div {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .full-width-chart .chart-container canvas,
        .full-width-chart .chart-container svg {
            max-width: 100% !important;
            width: 100% !important;
        }

        /* Custom Filter Styling */
        .custom-filter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: calc(var(--spacing-unit) * 1) 0;
            background-color: var(--color-highlight);
            border-radius: 4px;
            margin-top: calc(var(--spacing-unit) * 1);
            width: 100%;
        }

        .custom-filter-container label {
            font-family: var(--font-body);
            font-size: 0.9375rem; /* 15px - FILTER LABEL */
            font-weight: 600;
            color: var(--color-text);
            margin-right: 0.75rem;
        }

        .custom-filter-container select {
            font-family: var(--font-body);
            font-size: 0.9375rem; /* 15px - FILTER SELECT */
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 2px solid var(--color-accent-light);
            border-radius: 4px;
            background-color: white;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B4513' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }

        .custom-filter-container select:hover {
            border-color: var(--color-accent);
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.15);
        }

        .custom-filter-container select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
        }

        /* Chart containers - Overflow prevention */
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        .chart-container > div {
            width: 100%;
            max-width: 100%;
        }

        /* Force charts inside grid to respect container width */
        .section-grid .chart-container > div,
        .section-grid.reverse .chart-container > div,
        .section-grid.equal .chart-container > div {
            width: 100% !important;
            max-width: 100% !important;
        }

        .section-grid .chart-container svg,
        .section-grid.reverse .chart-container svg,
        .section-grid.equal .chart-container svg,
        .section-grid .chart-container canvas,
        .section-grid.reverse .chart-container canvas,
        .section-grid.equal .chart-container canvas {
            max-width: 100% !important;
            width: 100% !important;
            height: auto !important;
        }

        /* Updated Insight Cards - CONSISTENT TYPOGRAPHY */
        .insights-horizontal {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: calc(var(--spacing-unit) * 1.25);
            margin-top: calc(var(--spacing-unit) * 2);
        }

        .insight-card {
            background-color: var(--color-highlight);
            border-left: 4px solid var(--color-accent);
            padding: calc(var(--spacing-unit) * 1) calc(var(--spacing-unit) * 1.25);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .insight-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .insight-card h3 {
            font-family: var(--font-body);
            font-size: 1.0625rem; /* 17px - INSIGHT CARD TITLES (CONSISTENT) */
            font-weight: 600;
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            color: var(--color-accent);
        }

        .insight-card p {
            margin: 0;
            font-size: 0.9375rem; /* 15px - INSIGHT CARD TEXT */
            color: var(--color-text);
            line-height: 1.6;
        }

        .insights-four-column {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: calc(var(--spacing-unit) * 1);
        }

        .insights-four-column .insight-card {
            padding: calc(var(--spacing-unit) * 0.85) calc(var(--spacing-unit) * 1.1);
        }

        .insights-four-column .insight-card h3 {
            font-size: 1.0625rem; /* 17px - CONSISTENT */
            margin-bottom: calc(var(--spacing-unit) * 0.4);
        }

        .insights-four-column .insight-card p {
            font-size: 0.9375rem; /* 15px - CONSISTENT */
        }

        /* Insights Container in Grid - Vertical Alignment */
        .insights-container {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 1.25);
            height: 100%;
            justify-content: center;
        }

        .insights-container .insight-card {
            padding: calc(var(--spacing-unit) * 1) calc(var(--spacing-unit) * 1.25);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .insights-container .insight-card h3 {
            font-size: 1.0625rem; /* 17px - CONSISTENT */
            margin-bottom: calc(var(--spacing-unit) * 0.5);
        }

        .insights-container .insight-card p {
            font-size: 0.9375rem; /* 15px - CONSISTENT */
            flex-grow: 1;
        }

        /* Two-card layout - equal height */
        .insights-container.two-cards {
            justify-content: flex-start;
        }

        .insights-container.two-cards .insight-card {
            flex: 0 1 auto;
        }

        /* Section Spacing */
        section {
            margin-bottom: calc(var(--spacing-unit) * 5);
        }

        /* Footer */
        .metadata-footer {
            text-align: left;
            padding: calc(var(--spacing-unit) * 2) 0;
            margin-top: calc(var(--spacing-unit) * 6);
            border-top: 2px solid var(--color-accent);
            color: var(--color-subtle);
        }

        .metadata-footer p {
            margin: calc(var(--spacing-unit) * 0.33) 0;
            font-size: 0.9375rem; /* 15px - FOOTER TEXT */
            line-height: 1.6;
        }

        .metadata-footer strong {
            color: var(--color-text);
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .container {
                max-width: 95%;
            }
        }

        @media (max-width: 900px) {
            .section-grid,
            .section-grid.reverse,
            .section-grid.equal {
                grid-template-columns: 1fr;
                gap: calc(var(--spacing-unit) * 2);
            }

            .insights-horizontal {
                grid-template-columns: 1fr;
                gap: calc(var(--spacing-unit) * 1);
            }
            
            .insights-four-column {
                grid-template-columns: 1fr 1fr;
            }

            .container {
                padding: calc(var(--spacing-unit) * 2.5) calc(var(--spacing-unit) * 1.5);
            }

            h1 {
                font-size: 2.5rem;
            }

            h2 {
                font-size: 2rem;
            }
        }

        @media (max-width: 600px) {
            body {
                font-size: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.75rem;
            }

            .section-intro {
                font-size: 1rem;
                margin-bottom: calc(var(--spacing-unit) * 2);
            }

            .insight-card {
                padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1);
            }
            
            .insight-card h3 {
                font-size: 0.95rem;
            }
            
            .insight-card p {
                font-size: 0.875rem;
            }
            
            .insights-four-column {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 1);
            }
            
            .full-width-chart {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>

    <div class="container">

        <header>
            <h1>The World of Coffee</h1>
            <p class="subtitle">From the fertile soils of the Bean Belt to the world's favorite cup, explore the global story of coffee through data and discovery.</p>
        </header>

        <section>
            <h2>Where Coffee Grows: The Bean Belt</h2>
            <p class="section-intro">The narrow equatorial zone where <strong>climate meets altitude</strong> to create perfect growing conditions.</p>
            
            <div class="full-width-chart">
                <div class="chart-container">
                    <div>
                        <div id="map_coffee_production"></div>
                        <div class="custom-filter-container">
                            <label for="coffeeTypeSelect">Filter by Coffee Type:</label>
                            <select id="coffeeTypeSelect">
                                <option value="all">All Coffee Types</option>
                                <option value="Arabica">Arabica</option>
                                <option value="Robusta">Robusta</option>
                                <option value="Arabica/Robusta">Arabica/Robusta</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="insights-horizontal">
                </div>
            
            <div class="section-grid" style="margin-top: calc(var(--spacing-unit) * 3);">
                <div class="chart-container">
                    <div id="area_chart_production"></div>
                </div>
                <div class="insights-container">
                    </div>
            </div>
            
            <div class="section-grid reverse" style="margin-top: calc(var(--spacing-unit) * 2);">
                <div class="insights-container">
                    </div>
                <div class="chart-container">
                     <div id="Regional_coffee_production"></div>
                </div>
            </div>
        </section>

        <hr class="divider">

       <section>
            <div id="flow_import_export"></div>
            <div id="Top5_exporters"></div>
            <div id="Top5_importers"></div>
        </section>

        <hr class="divider">

        <section>
            <h2>Coffee Consumption Around the World</h2>
            <p class="section-intro">From <strong>Nordic coffee rituals</strong> to <strong>emerging markets</strong>, how the world drinks its coffee.</p>
            
            <div class="full-width-chart">
                <div class="chart-container">
                    <div>
                        <div id="linechart_coffee_consumption"></div>
                        <div class="custom-filter-container">
                            <label for="consumptionCountrySelect">Filter by Country:</label>
                            <select id="consumptionCountrySelect">
                                <option value="all">All Countries (Global Average)</option>
                                </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="Bar_country_comsumption"></div>
            <div id="Domestic_consumption_radial"></div>
        </section>

        <hr class="divider">

        <section>
            <div id="gdp_consumption_correlation"></div>
        </section>

        <hr class="divider">

        <section>
            <div id="dual_axis_coffee_cvd"></div>
        </section>

        <hr class="divider">

        <section>
            <div id="process_method_cup_points"></div>
        </section>  
        
       <footer class="metadata-footer">
            </footer>
    </div>

    <script>
        // --- 1. SETUP ---
        // Declare global variables to hold the Vega 'view' objects (the "remote controls" for the charts).
        // We set them to 'null' initially. They will be assigned a value once the charts are loaded.
        let mapView = null;
        let consumptionView = null;

        // --- 2. MAIN EXECUTION ---
        // Wait for the HTML document to be fully loaded and parsed before running any script.
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- 3. FILTER EVENT LISTENERS ---
            
            // == Coffee Type Filter (for the map) ==
            // Find the dropdown with the ID 'coffeeTypeSelect' and listen for a 'change' event.
            document.getElementById('coffeeTypeSelect').addEventListener('change', function(e) {
                // When it changes, get the selected value (e.g., "Arabica" or "all").
                const selectedType = e.target.value;
                
                // Check if the 'mapView' (the remote control) has been loaded and assigned.
                if (mapView) {
                    // If the user selected "All Coffee Types"...
                    if (selectedType === 'all') {
                        // ...send 'null' to the 'coffeeTypeFilter' signal in the Vega chart.
                        // The chart's JSON is set up to interpret 'null' as "show everything".
                        mapView.signal('coffeeTypeFilter', null).run();
                    } else {
                        // ...otherwise, send the specific string (e.g., "Arabica") to the signal.
                        // This will trigger the filter inside the Vega chart.
                        mapView.signal('coffeeTypeFilter', selectedType).run();
                    }
                }
            });

            // == Country Filter (for the consumption line chart) ==
            // Find the dropdown with the ID 'consumptionCountrySelect' and listen for a 'change' event.
            document.getElementById('consumptionCountrySelect').addEventListener('change', function(e) {
                // Get the selected country name (e.g., "Brazil").
                const selectedCountry = e.target.value;
                
                // Check if the 'consumptionView' (the remote) has been loaded.
                if (consumptionView) {
                    // If the user selected "All Countries"...
                    if (selectedCountry === 'all') {
                        // ...send 'null' to the 'countryFilter' signal.
                        consumptionView.signal('countryFilter', null).run();
                    } else {
                        // ...otherwise, send the specific country name to the signal.
                        consumptionView.signal('countryFilter', selectedCountry).run();
                    }
                }
            });

            // --- 4. DYNAMICALLY POPULATE COUNTRY FILTER ---
            // This code fetches the CSV data *again* just to build the filter dropdown.
            // This is smart because if the data changes, the filter updates automatically.
            fetch('Coffee_consumption_per_capita.csv')
                .then(response => response.text()) // Get the data as raw text.
                .then(data => {
                    // Split the text into an array of lines.
                    const lines = data.split('\n');
                    // Use a 'Set' to store country names. A Set automatically handles duplicates.
                    const countries = new Set();
                    
                    // Loop through all lines, starting from i=1 to skip the header row.
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim(); // Clean up whitespace.
                        if (line) {
                            // Get the first column (the country name) and remove any quotes.
                            const country = line.split(',')[0].replace(/^"|"$/g, '');
                            if (country) countries.add(country); // Add it to the Set.
                        }
                    }
                    
                    // Convert the Set to an Array and sort it alphabetically.
                    const sortedCountries = Array.from(countries).sort();
                    // Get the <select> element from the HTML.
                    const select = document.getElementById('consumptionCountrySelect');
                    
                    // Loop through the sorted list of countries.
                    sortedCountries.forEach(country => {
                        // Create a new <option> element.
                        const option = document.createElement('option');
                        option.value = country;       // Set its value (e.g., "Brazil")
                        option.textContent = country; // Set its display text (e.g., "Brazil")
                        select.appendChild(option); // Add the new <option> to the <select> menu.
                    });
                })
                .catch(error => console.error('Error loading countries:', error)); // Log any errors.

            // --- 5. CHART EMBEDDING ---
            
            // Define arrays of chart IDs to load. This simplifies the loading process.
            const fullWidthCharts = [
                'gdp_consumption_correlation',
                'dual_axis_coffee_cvd',
                'process_method_cup_points'
            ];
            
            const sideCharts = [
                'area_chart_production',
                'Regional_coffee_production',
                'flow_import_export',
                'Top5_exporters',
                'Top5_importers',
                'Bar_country_comsumption',
                'Domestic_consumption_radial'
            ];

            // == Load the two charts that have filters (mapView and consumptionView) ==
            // We load these separately so we can capture their 'view' objects in our global variables.
            
            vegaEmbed('#map_coffee_production', 'map_coffee_production.json', { "actions": false, "renderer": "svg" })
                .then(result => {
                    // SUCCESS: The chart is loaded. Save its "remote control" to our global variable.
                    mapView = result.view;
                }).catch(error => {
                    // FAILURE: Log the error and show a message to the user.
                    console.error('Error loading map:', error);
                    document.getElementById('map_coffee_production').innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">Map could not be loaded.</p>';
                });

            vegaEmbed('#linechart_coffee_consumption', 'linechart_coffee_consumption.json', { "actions": false, "renderer": "svg" })
                .then(result => {
                    // SUCCESS: Save the "remote control" for the consumption chart.
                    consumptionView = result.view;
                }).catch(error => {
                    // FAILURE: Log the error and show a message.
                    console.error('Error loading consumption chart:', error);
                    document.getElementById('linechart_coffee_consumption').innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">Chart could not be loaded.</p>';
                });

            // == Load all other charts using loops ==
            
            // Loop through the 'fullWidthCharts' array and load each one.
            fullWidthCharts.forEach(chartId => {
                const element = document.getElementById(chartId);
                if (element) {
                    // Embed the chart. The JSON filename must match the chart's ID.
                    vegaEmbed(`#${chartId}`, `${chartId}.json`, { "actions": false, "renderer": "svg" })
                        .catch(error => { // Add error handling for each chart
                            console.error(`Error loading ${chartId}:`, error);
                            element.innerHTML = `<p style="color: #999; text-align: center; padding: 2rem;">Chart could not be loaded.</p>`;
                        });
                }
            });

            // Loop through the 'sideCharts' array and load each one.
            sideCharts.forEach(chartId => {
                const element = document.getElementById(chartId);
                if (element) {
                    vegaEmbed(`#${chartId}`, `${chartId}.json`, { "actions": false, "renderer": "svg" })
                        .catch(error => { // Add error handling for each chart
                            console.error(`Error loading ${chartId}:`, error);
                            element.innerHTML = `<p style="color: #999; text-align: center; padding: 2rem;">Chart could not be loaded.</p>`;
                        });
                }
            });
        });
    </script>

</body>
</html>